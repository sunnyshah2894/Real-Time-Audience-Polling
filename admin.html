<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Socket.io</title>
  <link rel="stylesheet" href="./bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="./customCSS.css">
</head>

<body style="margin-top: 20px;">

<div class="container">
  <input type="hidden" id="adminID" name="adminID">
  <select class="custom-select custom-select-lg mb-3" id="myRoomSelection" name="room">
    <option selected val="Please select the room">Please select the room</option>
  </select>

  <div class="card">
    <div class="card-header">
      Add and Publish a new question
    </div>
    <div class="card-body">
      <h5 class="card-title">Add your question below</h5>
      <p class="card-text">
        <form id="myform" action="/admin/publishQuestion" method="POST">
          <div class="form-group">
            <label class="float-left" for="QuestionString">Enter the new question:</label>
            <textarea class="form-control" name="questionString" id="QuestionString" rows="3"></textarea>
          </div>
          <!-- <input type="text" placeholder="questionString" name="questionString"> -->
          <div class="form-row">
            <div class="form-group col-md-6 col-xs-12">
                <label class="float-left" for="inputPassword4">Option1</label>
                <input type="text" class="form-control" placeholder="option1" name="option1">
            </div>
            <div class="form-group col-md-6 col-xs-12">
                <label class="float-left" for="inputPassword4">Option2</label>
                <input type="text" class="form-control" placeholder="option2" name="option2">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6 col-xs-12">
                <label class="float-left" for="inputPassword4">Option3</label>
                <input type="text" class="form-control" placeholder="option3" name="option3">
            </div>
            <div class="form-group col-md-6 col-xs-12">
                <label class="float-left" for="inputPassword4">Option4</label>
                <input type="text" class="form-control" placeholder="option4" name="option4">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6 col-xs-12">
              <select class="custom-select custom-select-sm" id="answer" name="answer">
                <option value="1">option1</option>
                <option value="2">option2</option>
                <option value="3">option3</option>
                <option value="4">option4</option>
              </select>
            </div>
          </div>
          <!-- <button id="publishNewQuestion" type="button">Submit</button> -->
            <div class="form-group col-md-6 col-xs-12">
                <input class="btn btn-primary btn-block" type='submit' id='publishNewQuestion' value='Publish' />
            </div>
        </form>
      </p>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      Add a new question to the Room
    </div>
    <div class="card-body">
      <h5 class="card-title">Add your question below</h5>
      <p class="card-text">
        <form id="addQuestionForm" action="/admin/addQuestion" method="POST">
          <div class="form-group">
            <label class="float-left" for="QuestionString">Enter the new question:</label>
            <textarea class="form-control" name="questionString" id="QuestionString" rows="3"></textarea>
          </div>
          <!-- <input type="text" placeholder="questionString" name="questionString"> -->
          <div class="form-row">
            <div class="form-group col-md-6 col-xs-12">
                <label class="float-left" for="inputPassword4">Option1</label>
                <input type="text" class="form-control" placeholder="option1" name="option1">
            </div>
            <div class="form-group col-md-6 col-xs-12">
                <label class="float-left" for="inputPassword4">Option2</label>
                <input type="text" class="form-control" placeholder="option2" name="option2">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6 col-xs-12">
                <label class="float-left" for="inputPassword4">Option3</label>
                <input type="text" class="form-control" placeholder="option3" name="option3">
            </div>
            <div class="form-group col-md-6 col-xs-12">
                <label class="float-left" for="inputPassword4">Option4</label>
                <input type="text" class="form-control" placeholder="option4" name="option4">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6 col-xs-12">
              <select class="custom-select custom-select-sm" id="answer" name="answer">
                <option value="1">option1</option>
                <option value="2">option2</option>
                <option value="3">option3</option>
                <option value="4">option4</option>
              </select>
            </div>
          </div>
          <!-- <button id="publishNewQuestion" type="button">Submit</button> -->
            <div class="form-group col-md-6 col-xs-12">
                <input class="btn btn-primary btn-block" type='submit' id='addNewQuestion' value='Add Question' />
            </div>
        </form>
      </p>
    </div>
  </div>

<!--
  <form id="addQuestionForm" action="/admin/addQuestion" method="POST">
    <input type="text" placeholder="questionString" name="questionString">
    <input type="text" placeholder="option1" name="option1">
    <input type="text" placeholder="option2" name="option2">
    <input type="text" placeholder="option3" name="option3">
    <input type="text" placeholder="option4" name="option4">
    <select id="answer" name="answer">
      <option value="1">option1</option>
      <option value="2">option2</option>
      <option value="3">option3</option>
      <option value="4">option4</option>
    </select>
    <input type='submit' id='addNewQuestion' value='Add' />
  </form> -->

  <div class="card">
    <div class="card-header">
      Publish Existing Questions
    </div>
    <div class="card-body">
      <p class="card-text">

        <div id="publishableQuestions">

        </div>
      </p>
    </div>
  </div>

  <div id="adminGetUserNameModal" class="modal fade" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="myModalLabel">Enter admin username:</h3>
        </div>
        <div class="modal-body">
          <input class="form-control form-control-lg" id="username" type="text" placeholder="Enter username">
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="submitUsername">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <div id="snackbar">Thanks for answering!</div>
</div>
  <script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
  <script src="./bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>

  $.fn.serializeObject = function()
  {
    var o = {};
    var a = this.serializeArray();
    $.each(a, function() {
      if (o[this.name] !== undefined) {
        if (!o[this.name].push) {
          o[this.name] = [o[this.name]];
        }
        o[this.name].push(this.value || '');
      } else {
        o[this.name] = this.value || '';
      }
    });
    return o;
  };
  $(document).ready(function () {
    var socket = io.connect();

    //var userId = prompt("Enter the user ID: ");
    $('#adminGetUserNameModal').modal();

    $('#submitUsername').click(function(e){
      var username = $('#username').val();
      socket.emit('joinAsAdmin',username );
      $('#adminGetUserNameModal').modal('hide');
    });

    function showSnakbar(messageToShow) {
        var x = document.getElementById("snackbar");
        $('#snackbar').html(messageToShow);
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }


    socket.on('adminId',function(adminId){

      $('#adminID').val(adminId);

    });
    // The visitor is asked for their username...
    //var username = prompt('What\'s your username?');
    //var roomName = prompt("whats the room you are joining") ;
    // It's sent with the signal "little_newbie" (to differentiate it from "message")
    //socket.emit('little_newbie', username);
    // if (typeof(Storage) !== "undefined") {
    //     // Code for localStorage/sessionStorage.
    //     localStorage.setItem("username", username);
    // } else {
    //     // Sorry! No Web Storage support..
    // }

    socket.on("getRooms",function(rooms){
      $('#myRoomSelection option').remove();
      $('#myRoomSelection').append('<option selected val="Please select the room">Please select the room</option>');
      for (var i = 0; i < rooms.length; i++){
        var obj = rooms[i];
        var roomId = obj['_id'];
        var roomName = obj['adminRoomName']
        //var attrName = key;
        //var attrValue = obj[key];
        console.log(roomId);
        console.log(roomName);
        $('#myRoomSelection').append( '<option value="'+ roomId +'">' + roomName + '</option>' );

      }
      console.log("rooms to manage: " + rooms);
    });

    //socket.emit('joinRoom',roomName);
    // A dialog box is displayed when the server sends us a "message"
    socket.on('message', function(message) {
      alert('The server has a message for you: ' + message);
    })
    var questionsInRoom = {};
    socket.on('questionsAlreadyInRoom',function(questions){
      questionsInRoom = questions;
      console.log(questions);
      addQuestions(questions);

    });
    socket.on('refresh',function(message){

      location.reload();

    });
    socket.on('answerByUser',function(user){

      console.log(user);

    });
    function findElement(arr, propName, propValue) {
      console.log("propVlaue is " + propValue);
      for (var i=0; i < arr.length; i++){
        console.log("for i = " + i + " value is " + arr[i][propName]);
        if (arr[i][propName] === propValue)
        return arr[i];

      }

      // will return undefined if not found; you could return a default instead
    }

    function addQuestions(questions){
      var questionsHolder = $('#publishableQuestions');
      questionsHolder.empty();

      for( var i=0; i< questions.length; i++ ){
        var question = questions[i];
        getQuestionFormElement(question,i);
      }

    }

    function getQuestionFormElement(question,questionNumber){

      $("#publishableQuestions").append('<div class="card"><div class="card-body"><form class="ExistingQuestion" id="questionform'+questionNumber+'" method="POST">');
      $('#publishableQuestions #questionform'+questionNumber).append('<input type="hidden" disabled id="questionId" value="'+question._id+'" name="questionId"/>');
      $('#publishableQuestions #questionform'+questionNumber).append('<div class="form-group"><input class="form-control" type="text" disabled placeholder="questionString" name="questionString" value="'+question.questionString+'"></div>');
      $('#publishableQuestions #questionform'+questionNumber).append('<div class="form-row"><div class="form-group col-md-3 col-xs-12"><input type="text" class="form-control" disabled placeholder="option1" name="option1" value="'+question.options[0].optionValue+'"></div><div class="form-group col-md-3 col-xs-12"><input type="text" class="form-control" disabled placeholder="option2" name="option2" value="'+question.options[1].optionValue+'"></div><div class="form-group col-md-3 col-xs-12"><input type="text" class="form-control" disabled placeholder="option3" name="option3" value="'+question.options[2].optionValue+'"></div><div class="form-group col-md-3 col-xs-12"><input type="text" class="form-control" disabled placeholder="option4" name="option4" value="'+question.options[3].optionValue+'"></div></div>');
      //$('#publishableQuestions #questionform'+questionNumber).append('<div class="form-group col-md-3 col-xs-12"><input type="text" class="form-control" disabled placeholder="option2" name="option2" value="'+question.options[1].optionValue+'"></div>');
      //$('#publishableQuestions #questionform'+questionNumber).append('<div class="form-group col-md-3 col-xs-12"><input type="text" class="form-control" disabled placeholder="option3" name="option3" value="'+question.options[2].optionValue+'"></div>');
      //$('#publishableQuestions #questionform'+questionNumber).append('<div class="form-group col-md-3 col-xs-12"><input type="text" class="form-control" disabled placeholder="option4" name="option4" value="'+question.options[3].optionValue+'"></div></div>');
      $("#publishableQuestions #questionform"+questionNumber).append('<input class="btn btn-primary" type="submit" value="Submit" id="publishExistingQuestion'+questionNumber+'" />');
    }

    // When the button is clicked, a "message" is sent to the server
    // $('#poke').click(function () {
    //     socket.emit('message', 'Hi server, how are you?');
    // })

    $('#myRoomSelection').change(function(){
      var value = $('#myRoomSelection option:selected').text();
      var roomId = $('#myRoomSelection').val();
      var roomDetails = {
        roomName: value,
        roomID: roomId
      };
      socket.emit('serverJoinRoom',roomDetails);
    });

    $('#publishableQuestions').on('click', 'form', function(e){

      e.preventDefault();
      // do something here
      var disabled = $(this).find(':input:disabled').removeAttr('disabled');


      var formData = JSON.stringify($(this).serializeObject());
      var formDataObj = $(this).serializeObject();
      console.log( "as per the form data : " + formData );
      var dataFromQuestionJson = findElement(questionsInRoom,"_id",formDataObj["questionId"]);
      console.log( dataFromQuestionJson ) ;
      disabled.attr('disabled','disabled');
      socket.emit('publishExistingQuestion',dataFromQuestionJson);//JSON.parse(JSON.stringify(formData)));
      showSnakbar("Question sent to all the room attendees!");

    });

    $('#addNewQuestion').click(function(e){

      e.preventDefault();
      var formData = $('#addQuestionForm').serializeObject();
      formData["roomID"] = $('#myRoomSelection').val();
      socket.emit('adminAddNewQuestion',JSON.parse(JSON.stringify(formData)));
      showSnakbar("New question added");

    });

    // Listen to submit event on the <form> itself!
    $('#publishNewQuestion').click(function (e) {

      // Prevent form submission which refreshes page
      e.preventDefault();

      // Serialize data
      var formData = $("#myform").serializeObject();
      formData["roomID"] = $('#myRoomSelection').val();
      console.log("sedngin "+ formData);
      // $.ajax({
      //
      //     // The URL for the request
      //     url: "/admin/publishQuestion",
      //
      //     // The data to send (will be converted to a query string)
      //     data: formData,
      //
      //     // Whether this is a POST or GET request
      //     type: "POST",
      //
      //     // The type of data we expect back
      //     dataType : "json",
      // });

      //console.log("serialized json : " + $("#myform").serializeJSON());
      socket.emit('adminAddNewQuestion',JSON.parse(JSON.stringify(formData)));
      socket.emit('publishNewQuestion',JSON.parse(JSON.stringify(formData)));
      showSnakbar("New question sent to all the room attendees!");
      //return false;
      // Make AJAX request
    });
  });

  </script>
</body>
</html>
